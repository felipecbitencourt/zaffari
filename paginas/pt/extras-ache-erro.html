<!-- Extras - Ache o Erro -->
<div class="content-header">
    <h1 data-i18n="extras.ache-erro.title">üîç Ache o Erro</h1>
</div>

<div class="content-body">
    <!-- INICIO DO TEXTO EDIT√ÅVEL -->
    <p class="lead" data-i18n="extras.ache-erro.lead">Analise os e-mails fict√≠cios do SAC e identifique os erros
        clicando diretamente nas frases
        incorretas.</p>

    <div class="ache-erro-game" id="ache-erro-game">
        <!-- Seletor de E-mails -->
        <div class="email-selector">
            <button class="email-tab active" data-email="0" data-i18n="extras.ache-erro.ui.email_tabs.email1">üìß E-mail
                1</button>
            <button class="email-tab" data-email="1" data-i18n="extras.ache-erro.ui.email_tabs.email2">üìß E-mail
                2</button>
            <button class="email-tab" data-email="2" data-i18n="extras.ache-erro.ui.email_tabs.email3">üìß E-mail
                3</button>
            <button class="email-tab" data-email="3" data-i18n="extras.ache-erro.ui.email_tabs.email4">üìß E-mail
                4</button>
        </div>

        <!-- Status do Jogo -->
        <div class="game-status">
            <div class="game-stars" id="game-stars">
                <span class="star">‚≠ê</span>
                <span class="star">‚≠ê</span>
                <span class="star">‚≠ê</span>
            </div>
            <div class="game-progress-text">
                <span data-i18n="extras.ache-erro.ui.errors_found">Erros encontrados:</span> <span
                    id="erros-encontrados">0</span>/<span id="erros-total">3</span>
            </div>
        </div>

        <!-- Container do E-mail -->
        <div class="email-container" id="email-container">
            <div class="email-header-bar">
                <span class="email-icon">üìß</span>
                <span class="email-title" data-i18n="extras.ache-erro.ui.inbox">Caixa de Entrada</span>
            </div>
            <div class="email-meta">
                <div class="email-field"><strong data-i18n="extras.ache-erro.ui.from">De:</strong> <span
                        id="email-de">sac@empresa.com.br</span></div>
                <div class="email-field"><strong data-i18n="extras.ache-erro.ui.to">Para:</strong> <span
                        id="email-para">cliente@email.com</span></div>
                <div class="email-field"><strong data-i18n="extras.ache-erro.ui.subject">Assunto:</strong> <span
                        id="email-assunto">Re: Solicita√ß√£o</span>
                </div>
            </div>
            <div class="email-divider"></div>
            <div class="email-body" id="email-body">
                <!-- Conte√∫do do e-mail ser√° injetado via JS -->
            </div>
        </div>

        <!-- Feedback dos Erros Encontrados -->
        <div class="erros-feedback" id="erros-feedback">
            <h4 data-i18n="extras.ache-erro.ui.errors_identified">‚úÖ Erros Identificados:</h4>
            <div class="erros-list" id="erros-list">
                <!-- Erros encontrados aparecem aqui -->
            </div>
        </div>

        <!-- Mensagem de Conclus√£o -->
        <div class="email-completo" id="email-completo" style="display: none;">
            <div class="email-completo-content">
                <span class="email-completo-icon">üéâ</span>
                <h3 data-i18n="extras.ache-erro.completion.title">Parab√©ns!</h3>
                <p data-i18n="extras.ache-erro.completion.message">Voc√™ encontrou todos os erros deste e-mail!</p>
                <button class="btn-proximo-email" id="btn-proximo-email"
                    data-i18n="extras.ache-erro.completion.next_btn">Pr√≥ximo E-mail ‚Üí</button>
            </div>
        </div>

        <!-- Resumo Final -->
        <div class="resumo-final" id="resumo-final" style="display: none;">
            <div class="resumo-final-content">
                <span class="resumo-icon">üèÜ</span>
                <h3 data-i18n="extras.ache-erro.completion.final_title">Jogo Conclu√≠do!</h3>
                <p data-i18n="extras.ache-erro.completion.final_message">Voc√™ completou todos os e-mails!</p>
                <div class="resumo-estrelas" id="resumo-estrelas"></div>
                <button class="btn-reiniciar" id="btn-reiniciar" data-i18n="extras.ache-erro.completion.restart_btn">üîÑ
                    Jogar Novamente</button>
            </div>
        </div>
    </div>

    <!-- Bot√£o Voltar -->
    <div class="extras-back-container" style="margin-top: var(--spacing-xl); text-align: center;">
        <button class="btn-extras-back" onclick="navigateToPage('extras-hub')">‚Üê Voltar ao Menu de Extras</button>
    </div>
    <!-- FIM DO TEXTO EDIT√ÅVEL -->
</div>

<script>
    function initAcheErro() {
        // Dados dos E-mails via I18n
        let emailsData = [];
        const t = (window.I18n && window.I18n.t) ? window.I18n.t : (k) => k;

        // DEBUG
        console.log("I18n Global (Ache Erro):", window.I18n);
        if (window.I18n) console.log("Translations:", window.I18n.translations);

        try {
            if (window.I18n && window.I18n.translations &&
                window.I18n.translations.extras &&
                window.I18n.translations.extras['ache-erro']) {
                emailsData = window.I18n.translations.extras['ache-erro'].emails;
            }
        } catch (e) {
            console.error("Erro ao carregar e-mails do I18n", e);
        }

        if (!emailsData || emailsData.length === 0) {
            console.warn("Emails n√£o encontrados nas tradu√ß√µes.");
            document.getElementById('email-container').innerHTML = '<p class="error-msg">Erro: Dados do jogo n√£o carregados.</p>';
            return;
        }

        // Estado do jogo
        let currentEmail = 0;
        let errosEncontrados = [];
        let cliquesErrados = 0;
        let estrelasTotal = [];

        // Elementos DOM
        const emailContainer = document.getElementById('email-container');
        const emailBody = document.getElementById('email-body');
        const emailDe = document.getElementById('email-de');
        const emailPara = document.getElementById('email-para');
        const emailAssunto = document.getElementById('email-assunto');
        const errosEncontradosEl = document.getElementById('erros-encontrados');
        const errosTotalEl = document.getElementById('erros-total');
        const errosList = document.getElementById('erros-list');
        const errosFeedback = document.getElementById('erros-feedback');
        const emailCompleto = document.getElementById('email-completo');
        const resumoFinal = document.getElementById('resumo-final');
        const gameStars = document.getElementById('game-stars');
        const emailTabs = document.querySelectorAll('.email-tab');

        // Carregar e-mail
        function loadEmail(index) {
            const email = emailsData[index];
            currentEmail = index;
            errosEncontrados = [];
            cliquesErrados = 0;

            // Atualizar header
            emailDe.textContent = email.de;
            emailPara.textContent = email.para;
            emailAssunto.textContent = email.assunto;

            // Atualizar corpo (converter quebras de linha)
            emailBody.innerHTML = email.corpo.replace(/\n/g, '<br>');

            // Atualizar contadores
            const totalErros = Object.keys(email.erros).length;
            errosEncontradosEl.textContent = '0';
            errosTotalEl.textContent = totalErros;

            // Limpar feedback
            errosList.innerHTML = '';
            errosFeedback.style.display = 'none';
            emailCompleto.style.display = 'none';

            // Reset estrelas
            updateStars(3);

            // Atualizar tabs
            emailTabs.forEach((tab, i) => {
                tab.classList.toggle('active', i === index);
                if (estrelasTotal[i] !== undefined) {
                    tab.classList.add('completed');
                }
            });

            // Bind eventos nos erros
            bindErroEvents();
        }

        // Bind eventos de clique nos erros
        function bindErroEvents() {
            const erroElements = emailBody.querySelectorAll('.erro');
            erroElements.forEach(el => {
                el.addEventListener('click', handleErroClick);
            });

            // Clique em √°rea normal (n√£o erro)
            emailBody.addEventListener('click', function (e) {
                if (!e.target.classList.contains('erro') && !e.target.closest('.erro')) {
                    handleWrongClick();
                }
            });
        }

        // Clique em erro correto
        function handleErroClick(e) {
            e.stopPropagation();
            const el = e.target;
            const erroId = el.dataset.erro;
            const email = emailsData[currentEmail];

            if (el.classList.contains('found')) return;

            // Marcar como encontrado
            el.classList.add('found');
            errosEncontrados.push(erroId);

            // Atualizar contador
            errosEncontradosEl.textContent = errosEncontrados.length;

            // Mostrar explica√ß√£o
            const erroInfo = email.erros[erroId];
            const feedbackItem = document.createElement('div');
            feedbackItem.className = 'erro-feedback-item';
            feedbackItem.innerHTML = `
                <div class="erro-texto">"${erroInfo.texto}"</div>
                <div class="erro-explicacao">${erroInfo.explicacao}</div>
            `;
            errosList.appendChild(feedbackItem);
            errosFeedback.style.display = 'block';

            // Som de sucesso
            if (typeof AudioManager !== 'undefined') AudioManager.playSuccess();

            // Verificar se completou
            const totalErros = Object.keys(email.erros).length;
            if (errosEncontrados.length === totalErros) {
                completeEmail();
            }
        }

        // Clique errado
        function handleWrongClick() {
            cliquesErrados++;
            updateStars(calcStars());

            // Feedback visual
            emailContainer.classList.add('shake');
            setTimeout(() => emailContainer.classList.remove('shake'), 500);

            // Som de erro
            if (typeof AudioManager !== 'undefined') AudioManager.playError();
        }

        // Calcular estrelas
        function calcStars() {
            if (cliquesErrados === 0) return 3;
            if (cliquesErrados <= 2) return 2;
            return 1;
        }

        // Atualizar estrelas visuais
        function updateStars(count) {
            const stars = gameStars.querySelectorAll('.star');
            stars.forEach((star, i) => {
                star.classList.toggle('active', i < count);
                star.classList.toggle('inactive', i >= count);
            });
        }

        // E-mail completo
        function completeEmail() {
            estrelasTotal[currentEmail] = calcStars();

            // Atualizar tab visualmente
            // Atualizar tab visualmente
            emailTabs[currentEmail].classList.add('completed');
            // Recriar texto da tab mantendo √≠cone e adicionando estrelas. 
            // Como o texto original vem do HTML (que agora tem data-i18n?), melhor usar o texto atual ou reconstruir.
            // O HTML inicial tem "üìß E-mail 1".
            // Vamos usar t() se poss√≠vel ou pegar o texto base do JSON.
            const baseText = t(`extras.ache-erro.ui.email_tabs.email${currentEmail + 1}`) || `üìß E-mail ${currentEmail + 1}`;
            emailTabs[currentEmail].innerHTML = `${baseText} ${'‚≠ê'.repeat(estrelasTotal[currentEmail])}`;

            // Disparar confete
            createConfetti();

            // Aguardar para mostrar o popup, permitindo ler a explica√ß√£o
            setTimeout(() => {
                emailCompleto.style.display = 'flex';
            }, 3000);

            // Verificar se todos completos
            if (estrelasTotal.filter(s => s !== undefined).length === emailsData.length) {
                const btn = document.getElementById('btn-proximo-email');
                if (btn) btn.textContent = t('extras.ache-erro.completion.view_summary');
            }
        }

        // Fun√ß√£o simples de confete
        function createConfetti() {
            const colors = ['#D32F2F', '#FFC107', '#2196F3', '#4CAF50'];
            for (let i = 0; i < 50; i++) {
                const confetto = document.createElement('div');
                confetto.classList.add('confetti');
                confetto.style.left = Math.random() * 100 + 'vw';
                confetto.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetto.style.animationDuration = (Math.random() * 2 + 2) + 's';
                document.body.appendChild(confetto);

                // Remover ap√≥s anima√ß√£o
                setTimeout(() => confetto.remove(), 4000);
            }
        }

        // Pr√≥ximo e-mail
        document.getElementById('btn-proximo-email').addEventListener('click', function () {
            if (estrelasTotal.filter(s => s !== undefined).length === emailsData.length) {
                showResumo();
            } else {
                const nextEmail = (currentEmail + 1) % emailsData.length;
                loadEmail(nextEmail);
            }
        });

        // Mostrar resumo final
        function showResumo() {
            emailCompleto.style.display = 'none';
            resumoFinal.style.display = 'flex';

            const totalEstrelas = estrelasTotal.reduce((a, b) => a + b, 0);
            const maxEstrelas = emailsData.length * 3;

            const totalText = t('extras.ache-erro.completion.total_stars').replace('{count}', totalEstrelas).replace('{max}', maxEstrelas);

            document.getElementById('resumo-estrelas').innerHTML = `
                <p>${totalText}</p>
                <div class="estrelas-grandes">${'‚≠ê'.repeat(Math.round(totalEstrelas / emailsData.length))}</div>
            `;
        }

        // Reiniciar
        document.getElementById('btn-reiniciar').addEventListener('click', function () {
            estrelasTotal = [];
            resumoFinal.style.display = 'none';
            emailTabs.forEach((tab, i) => {
                tab.classList.remove('completed');
                tab.innerHTML = t(`extras.ache-erro.ui.email_tabs.email${i + 1}`) || `üìß E-mail ${i + 1}`;
            });
            loadEmail(0);
        });

        // Tabs de e-mail
        emailTabs.forEach((tab, i) => {
            tab.addEventListener('click', function () {
                loadEmail(i);
            });
        });

        // Iniciar
        loadEmail(0);
    }

    // Inicializar ap√≥s pequeno delay
    setTimeout(initAcheErro, 50);
</script>