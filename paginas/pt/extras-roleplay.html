<!-- Extras - Roleplay -->
<div class="content-header">
    <h1 data-i18n="extras.roleplay.title">üé≠ Roleplay - Simula√ß√£o de Atendimento</h1>
</div>

<div class="content-body">
    <!-- INICIO DO TEXTO EDIT√ÅVEL -->
    <p class="lead" data-i18n="extras.roleplay.lead">Pratique suas habilidades de atendimento! Voc√™ √© o atendente SAC e
        deve escolher as melhores
        respostas.</p>

    <div class="roleplay-game" id="roleplay-game">
        <!-- Container do Jogo -->
        <div class="roleplay-scene">
            <!-- Cen√°rio de Fundo -->
            <div class="roleplay-background">
                <img src="assets/images/roleplay/cenario.png" alt="Cen√°rio SAC">
            </div>

            <!-- Personagem Cliente -->
            <div class="roleplay-character cliente">
                <img src="assets/images/roleplay/cliente_neutro.png" alt="Cliente" id="cliente-img">
            </div>

            <!-- Bal√£o de Fala do Cliente -->
            <div class="roleplay-speech-bubble" id="speech-bubble">
                <p id="cliente-fala" data-i18n="extras.roleplay.ui.loading">Carregando...</p>
            </div>

            <!-- Personagem Atendente (oculto at√© resposta correta) -->
            <div class="roleplay-character atendente" id="atendente-container" style="display: none;">
                <img src="assets/images/roleplay/atendente.png" alt="Atendente" id="atendente-img">
            </div>

            <!-- Bal√£o de Fala do Atendente (oculto at√© resposta correta) -->
            <div class="roleplay-speech-bubble atendente-bubble" id="atendente-bubble" style="display: none;">
                <p id="atendente-fala"></p>
            </div>

            <!-- Indicador de Etapa -->
            <div class="roleplay-step-indicator">
                <span id="step-current">1</span> / <span id="step-total">4</span>
            </div>
        </div>

        <!-- Op√ß√µes de Resposta -->
        <div class="roleplay-options" id="roleplay-options">
            <!-- Op√ß√µes ser√£o injetadas via JS -->
        </div>

        <!-- Feedback -->
        <div class="roleplay-feedback" id="roleplay-feedback" style="display: none;">
            <div class="feedback-content" id="feedback-content"></div>
            <button class="btn-continuar" id="btn-continuar" data-i18n="extras.roleplay.ui.continue_btn">Continuar
                ‚Üí</button>
        </div>

        <!-- Resultado Final -->
        <div class="roleplay-resultado" id="roleplay-resultado" style="display: none;">
            <div class="resultado-content">
                <span class="resultado-icon">üéâ</span>
                <h3 data-i18n="extras.roleplay.completion.title">Parab√©ns!</h3>
                <p data-i18n="extras.roleplay.completion.message">Voc√™ completou a simula√ß√£o de atendimento!</p>
                <div class="resultado-score" id="resultado-score"></div>
                <button class="btn-reiniciar-roleplay" id="btn-reiniciar-roleplay"
                    data-i18n="extras.roleplay.completion.restart_btn">üîÑ Jogar Novamente</button>
            </div>
        </div>

        <!-- Modal de Feedback para Resposta Incorreta -->
        <div class="roleplay-modal-overlay" id="roleplay-error-modal" style="display: none;">
            <div class="roleplay-modal">
                <div class="roleplay-modal-icon">‚ùå</div>
                <div class="roleplay-modal-text" id="roleplay-modal-text"></div>
                <button class="roleplay-modal-btn" id="btn-fechar-modal"
                    data-i18n="extras.roleplay.ui.try_again_btn">Tentar Novamente</button>
            </div>
        </div>
    </div>

    <style>
        /* Modal de Feedback Incorreto */
        .roleplay-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.2s ease;
        }

        .roleplay-modal {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .roleplay-modal-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .roleplay-modal-text {
            font-size: 1rem;
            color: #333;
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        .roleplay-modal-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .roleplay-modal-btn:hover {
            background: #c82333;
        }

        /* Dark mode */
        body.high-contrast .roleplay-modal {
            background: #2d2d2d;
        }

        body.high-contrast .roleplay-modal-text {
            color: #f0f0f0;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>

    <!-- Bot√£o Voltar -->
    <div class="extras-back-container" style="margin-top: var(--spacing-xl); text-align: center;">
        <button class="btn-extras-back" onclick="navigateToPage('extras-hub')">‚Üê Voltar ao Menu de Extras</button>
    </div>
    <!-- FIM DO TEXTO EDIT√ÅVEL -->
</div>

<script>
    function initRoleplay() {
        // Dados do Cen√°rio via I18n
        let cenario;

        // DEBUG: Verificar estrutura
        console.log("I18n Global:", window.I18n);
        if (window.I18n) console.log("Translations:", window.I18n.translations);

        try {
            // Tentar carregar do objeto I18n global se poss√≠vel
            // Estrutura correta: I18n.translations.extras.roleplay.scenario
            if (window.I18n && window.I18n.translations &&
                window.I18n.translations.extras &&
                window.I18n.translations.extras.roleplay) {
                cenario = window.I18n.translations.extras.roleplay.scenario;
            }
        } catch (e) {
            console.error("Erro ao carregar cen√°rio do I18n", e);
        }

        // Fallback: cen√°rio hardcoded removido. Se n√£o carregar, mostrar erro ou objeto vazio.
        if (!cenario) {
            console.warn("Cen√°rio n√£o encontrado nas tradu√ß√µes. Verifique o arquivo roleplay.json.");
            cenario = { title: "Error", etapas: [] };
        }

        // Estado do jogo
        let currentStep = 0;
        let acertos = 0;
        let totalSteps = cenario.steps.length;

        // ===== AUDIO SETUP =====
        // M√∫sica de fundo (volume baixo)
        const bgMusic = new Audio('assets/mixkit-disco-aint-old-school-935.mp3');
        bgMusic.loop = true;
        bgMusic.volume = 0.15; // Volume baixo

        // Web Audio API para efeito de murm√∫rio
        let audioContext = null;
        let murmurOscillator = null;
        let murmurGain = null;

        function startMurmur() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (murmurOscillator) return; // J√° est√° tocando

            murmurOscillator = audioContext.createOscillator();
            murmurGain = audioContext.createGain();

            // Configurar oscilador para som de murm√∫rio suave
            murmurOscillator.type = 'sine';
            murmurOscillator.frequency.setValueAtTime(180, audioContext.currentTime);

            // Volume muito baixo
            murmurGain.gain.setValueAtTime(0.03, audioContext.currentTime);

            // Conectar
            murmurOscillator.connect(murmurGain);
            murmurGain.connect(audioContext.destination);

            // Modula√ß√£o para parecer fala
            const lfo = audioContext.createOscillator();
            const lfoGain = audioContext.createGain();
            lfo.frequency.setValueAtTime(8, audioContext.currentTime);
            lfoGain.gain.setValueAtTime(20, audioContext.currentTime);
            lfo.connect(lfoGain);
            lfoGain.connect(murmurOscillator.frequency);
            lfo.start();

            murmurOscillator.start();
        }

        function stopMurmur() {
            if (murmurOscillator) {
                murmurOscillator.stop();
                murmurOscillator = null;
            }
        }

        // Iniciar m√∫sica automaticamente ao carregar
        bgMusic.play().catch(() => { });

        // Fun√ß√£o de cleanup para parar m√∫sica (chamada pelo app.js ao trocar p√°gina)
        function cleanupRoleplay() {
            bgMusic.pause();
            bgMusic.currentTime = 0;
            stopMurmur();
            if (audioContext) {
                audioContext.close().catch(() => { });
                audioContext = null;
            }
        }

        // Registrar cleanup globalmente para que app.js possa chamar
        window.roleplayCleanup = cleanupRoleplay;

        // Parar m√∫sica ao sair da p√°gina (fallback)
        window.addEventListener('beforeunload', cleanupRoleplay);

        // Elementos DOM
        const clienteFala = document.getElementById('cliente-fala');
        const speechBubble = document.getElementById('speech-bubble');
        const optionsContainer = document.getElementById('roleplay-options');
        const feedbackContainer = document.getElementById('roleplay-feedback');
        const feedbackContent = document.getElementById('feedback-content');
        const btnContinuar = document.getElementById('btn-continuar');
        const resultadoContainer = document.getElementById('roleplay-resultado');
        const stepCurrent = document.getElementById('step-current');
        const stepTotal = document.getElementById('step-total');

        if (!clienteFala || !optionsContainer) {
            console.error('Roleplay elements not found');
            setTimeout(initRoleplay, 100);
            return;
        }

        // Efeito m√°quina de escrever para cliente
        function typeWriter(element, text, speed, callback) {
            let i = 0;
            element.textContent = '';
            const clienteImg = document.getElementById('cliente-img');

            // Adicionar classe de tremor ao cliente e iniciar murm√∫rio
            if (clienteImg) {
                clienteImg.classList.add('speaking');
            }
            startMurmur();

            function type() {
                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                } else {
                    // Remover tremor e parar murm√∫rio quando terminar
                    if (clienteImg) {
                        clienteImg.classList.remove('speaking');
                    }
                    stopMurmur();
                    if (callback) callback();
                }
            }
            type();
        }

        // Efeito m√°quina de escrever para atendente (treme o atendente)
        function typeWriterAtendente(element, text, speed, callback) {
            let i = 0;
            element.textContent = '';
            const atendenteImg = document.getElementById('atendente-img');

            // Adicionar classe de tremor ao atendente e iniciar murm√∫rio
            if (atendenteImg) {
                atendenteImg.classList.add('speaking');
            }
            startMurmur();

            function type() {
                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                } else {
                    // Remover tremor e parar murm√∫rio quando terminar
                    if (atendenteImg) {
                        atendenteImg.classList.remove('speaking');
                    }
                    stopMurmur();
                    if (callback) callback();
                }
            }
            type();
        }

        // Carregar etapa
        function loadStep(stepIndex) {
            const etapa = cenario.steps[stepIndex];
            currentStep = stepIndex;

            // Atualizar indicador
            stepCurrent.textContent = stepIndex + 1;
            stepTotal.textContent = totalSteps;

            // Esconder atendente da etapa anterior
            const atendenteContainer = document.getElementById('atendente-container');
            const atendenteBubble = document.getElementById('atendente-bubble');
            if (atendenteContainer) atendenteContainer.style.display = 'none';
            if (atendenteBubble) atendenteBubble.style.display = 'none';

            // Esconder op√ß√µes enquanto texto aparece
            optionsContainer.style.display = 'none';
            optionsContainer.innerHTML = '';

            // Efeito typewriter na fala do cliente
            typeWriter(clienteFala, etapa.client_speech, 30, function () {
                // Mostrar op√ß√µes depois que o texto terminar
                etapa.options.forEach((opcao, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'roleplay-option';
                    btn.innerHTML = `<span class="option-letter">${String.fromCharCode(65 + index)}</span> ${opcao.text}`;
                    btn.addEventListener('click', function () {
                        handleOptionClick(opcao, btn);
                    });
                    optionsContainer.appendChild(btn);
                });
                optionsContainer.style.display = 'flex';
            });

            // Esconder feedback
            feedbackContainer.style.display = 'none';
        }

        // Clique em op√ß√£o
        function handleOptionClick(opcao, btn) {
            // Refer√™ncia para todas as op√ß√µes (usada depois)
            const allOptions = optionsContainer.querySelectorAll('.roleplay-option');

            // Marcar selecionada
            btn.classList.add('selected');

            // Elementos do atendente
            const atendenteContainer = document.getElementById('atendente-container');
            const atendenteBubble = document.getElementById('atendente-bubble');
            const atendenteFala = document.getElementById('atendente-fala');
            const atendenteImg = document.getElementById('atendente-img');

            if (opcao.correct) {
                btn.classList.add('correct');
                acertos++;
                if (typeof AudioManager !== 'undefined') AudioManager.playSuccess();

                // Desabilitar todas as op√ß√µes ao acertar
                allOptions.forEach(opt => {
                    opt.disabled = true;
                    opt.classList.add('disabled');
                });

                // Esconder op√ß√µes de resposta
                optionsContainer.style.display = 'none';

                // Mostrar atendente com resposta
                if (atendenteContainer && atendenteBubble) {
                    atendenteContainer.style.display = 'block';
                    atendenteBubble.style.display = 'block';

                    // Typewriter para resposta do atendente (treme o atendente)
                    typeWriterAtendente(atendenteFala, opcao.text, 25, function () {
                        // Ap√≥s terminar, mostrar feedback
                        feedbackContent.innerHTML = `
                            <div class="feedback-icon">‚úÖ</div>
                            <p>${opcao.feedback}</p>
                        `;
                        feedbackContainer.style.display = 'block';
                        feedbackContainer.className = 'roleplay-feedback success';
                    });
                }
            } else {
                btn.classList.add('incorrect');
                if (typeof AudioManager !== 'undefined') AudioManager.playError();

                // Esconder atendente em resposta errada
                if (atendenteContainer) atendenteContainer.style.display = 'none';
                if (atendenteBubble) atendenteBubble.style.display = 'none';

                // Mostrar modal de feedback em vez de feedback inline
                const errorModal = document.getElementById('roleplay-error-modal');
                const modalText = document.getElementById('roleplay-modal-text');
                if (errorModal && modalText) {
                    modalText.textContent = opcao.feedback;
                    errorModal.style.display = 'flex';
                }

                // Desabilitar op√ß√£o errada imediatamente
                btn.disabled = true;
                btn.classList.add('disabled');
            }
        }

        // Continuar para pr√≥xima etapa
        btnContinuar.addEventListener('click', function () {
            if (currentStep < totalSteps - 1) {
                loadStep(currentStep + 1);
            } else {
                showResultado();
            }
        });

        // Mostrar resultado
        function showResultado() {
            optionsContainer.style.display = 'none';
            feedbackContainer.style.display = 'none';
            speechBubble.style.display = 'none';
            resultadoContainer.style.display = 'flex';

            const porcentagem = Math.round((acertos / totalSteps) * 100);
            let mensagem = '';
            let estrelas = '';

            const t = (window.I18n && window.I18n.t) ? window.I18n.t : (k) => k;

            if (porcentagem === 100) {
                mensagem = t('extras.roleplay.results.perfect');
                estrelas = '‚≠ê‚≠ê‚≠ê';
            } else if (porcentagem >= 75) {
                mensagem = t('extras.roleplay.results.good');
                estrelas = '‚≠ê‚≠ê';
            } else if (porcentagem >= 50) {
                mensagem = t('extras.roleplay.results.average');
                estrelas = '‚≠ê';
            } else {
                mensagem = t('extras.roleplay.results.needs_work');
                estrelas = '';
            }

            const scoreText = t('extras.roleplay.completion.correct_count').replace('{correct}', acertos).replace('{total}', totalSteps);

            document.getElementById('resultado-score').innerHTML = `
                <div class="score-estrelas">${estrelas}</div>
                <div class="score-texto">${scoreText}</div>
                <div class="score-mensagem">${mensagem}</div>
            `;
        }

        // Reiniciar
        document.getElementById('btn-reiniciar-roleplay').addEventListener('click', function () {
            acertos = 0;
            resultadoContainer.style.display = 'none';
            speechBubble.style.display = 'block';
            loadStep(0);
        });

        // Fechar modal de erro
        document.getElementById('btn-fechar-modal').addEventListener('click', function () {
            document.getElementById('roleplay-error-modal').style.display = 'none';
        });

        // Iniciar
        loadStep(0);
    }

    // Inicializar ap√≥s delay
    setTimeout(initRoleplay, 50);
</script>