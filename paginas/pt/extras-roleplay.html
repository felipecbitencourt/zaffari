<!-- Extras - Roleplay -->
<div class="content-header">
    <h1>üé≠ Roleplay - Simula√ß√£o de Atendimento</h1>
</div>

<div class="content-body">
    <!-- INICIO DO TEXTO EDIT√ÅVEL -->
    <p class="lead">Pratique suas habilidades de atendimento! Voc√™ √© o atendente SAC e deve escolher as melhores
        respostas.</p>

    <div class="roleplay-game" id="roleplay-game">
        <!-- Container do Jogo -->
        <div class="roleplay-scene">
            <!-- Cen√°rio de Fundo -->
            <div class="roleplay-background">
                <img src="assets/images/roleplay/cenario.png" alt="Cen√°rio SAC">
            </div>

            <!-- Personagem Cliente -->
            <div class="roleplay-character cliente">
                <img src="assets/images/roleplay/cliente_neutro.png" alt="Cliente" id="cliente-img">
            </div>

            <!-- Bal√£o de Fala do Cliente -->
            <div class="roleplay-speech-bubble" id="speech-bubble">
                <p id="cliente-fala">Carregando...</p>
            </div>

            <!-- Personagem Atendente (oculto at√© resposta correta) -->
            <div class="roleplay-character atendente" id="atendente-container" style="display: none;">
                <img src="assets/images/roleplay/atendente.png" alt="Atendente" id="atendente-img">
            </div>

            <!-- Bal√£o de Fala do Atendente (oculto at√© resposta correta) -->
            <div class="roleplay-speech-bubble atendente-bubble" id="atendente-bubble" style="display: none;">
                <p id="atendente-fala"></p>
            </div>

            <!-- Indicador de Etapa -->
            <div class="roleplay-step-indicator">
                <span id="step-current">1</span> / <span id="step-total">4</span>
            </div>
        </div>

        <!-- Op√ß√µes de Resposta -->
        <div class="roleplay-options" id="roleplay-options">
            <!-- Op√ß√µes ser√£o injetadas via JS -->
        </div>

        <!-- Feedback -->
        <div class="roleplay-feedback" id="roleplay-feedback" style="display: none;">
            <div class="feedback-content" id="feedback-content"></div>
            <button class="btn-continuar" id="btn-continuar">Continuar ‚Üí</button>
        </div>

        <!-- Resultado Final -->
        <div class="roleplay-resultado" id="roleplay-resultado" style="display: none;">
            <div class="resultado-content">
                <span class="resultado-icon">üéâ</span>
                <h3>Parab√©ns!</h3>
                <p>Voc√™ completou a simula√ß√£o de atendimento!</p>
                <div class="resultado-score" id="resultado-score"></div>
                <button class="btn-reiniciar-roleplay" id="btn-reiniciar-roleplay">üîÑ Jogar Novamente</button>
            </div>
        </div>
    </div>

    <!-- Bot√£o Voltar -->
    <div class="extras-back-container" style="margin-top: var(--spacing-xl); text-align: center;">
        <button class="btn-extras-back" onclick="navigateToPage('extras-hub')">‚Üê Voltar ao Menu de Extras</button>
    </div>
    <!-- FIM DO TEXTO EDIT√ÅVEL -->
</div>

<script>
    function initRoleplay() {
        // Dados do Cen√°rio
        const cenario = {
            titulo: "Troca de Produto",
            etapas: [
                {
                    id: 1,
                    nome: "Apresenta√ß√£o",
                    clienteFala: "Ol√°, boa tarde! Comprei esse liquidificador aqui ontem e gostaria de trocar por outro modelo.",
                    opcoes: [
                        {
                            texto: "Boa tarde! Claro, posso ajud√°-lo com isso. O produto apresenta algum defeito ou problema?",
                            correta: true,
                            feedback: "Excelente! Voc√™ cumprimentou o cliente de forma cordial e j√° fez uma pergunta importante para entender a situa√ß√£o."
                        },
                        {
                            texto: "Infelizmente n√£o √© poss√≠vel trocar produtos que j√° foram comprados e levados para casa.",
                            correta: false,
                            feedback: "Essa resposta √© muito negativa e n√£o acolhe o cliente. Sempre devemos primeiro entender a situa√ß√£o antes de negar algo."
                        },
                        {
                            texto: "Pode deixar o produto a√≠ no balc√£o que depois algu√©m vai verificar para voc√™.",
                            correta: false,
                            feedback: "Essa resposta √© informal demais e n√£o demonstra interesse em ajudar o cliente. O atendimento deve ser sempre cordial e profissional."
                        }
                    ]
                },
                {
                    id: 2,
                    nome: "Quest√£o do Cliente",
                    clienteFala: "N√£o, n√£o est√° com defeito. √â que eu vi outro modelo que me agradou mais. Vi na internet que tenho direito de trocar em 7 dias, n√£o √©?",
                    opcoes: [
                        {
                            texto: "Sim, com certeza! Voc√™ tem esse direito garantido por lei. Vamos fazer a troca agora mesmo.",
                            correta: false,
                            feedback: "Cuidado! O direito de arrependimento de 7 dias s√≥ vale para compras ONLINE. Em loja f√≠sica, a troca √© pol√≠tica comercial, n√£o direito legal."
                        },
                        {
                            texto: "O direito de 7 dias vale para compras online. Em loja f√≠sica √© cortesia. Posso verificar nossa pol√≠tica!",
                            correta: true,
                            feedback: "Perfeito! Voc√™ explicou corretamente a diferen√ßa entre o direito legal (compras online) e a pol√≠tica comercial (loja f√≠sica), sem negar ajuda ao cliente."
                        },
                        {
                            texto: "Essa regra dos 7 dias √© s√≥ para compras online, ent√£o aqui n√£o se aplica. Sinto muito.",
                            correta: false,
                            feedback: "Embora a informa√ß√£o sobre o online esteja correta, a resposta √© muito negativa. Sempre devemos buscar alternativas para ajudar o cliente."
                        }
                    ]
                },
                {
                    id: 3,
                    nome: "D√∫vida Adicional",
                    clienteFala: "Ah entendi... ent√£o voc√™s n√£o v√£o trocar? E se o produto tiver defeito depois, posso reclamar?",
                    opcoes: [
                        {
                            texto: "Pode sim! Para defeitos voc√™ tem 90 dias. E nossa pol√≠tica permite troca em 30 dias com nota fiscal!",
                            correta: true,
                            feedback: "Excelente! Voc√™ informou corretamente o prazo de 90 dias para reclamar de defeitos em produtos dur√°veis E ainda ofereceu a possibilidade de troca pela pol√≠tica da empresa."
                        },
                        {
                            texto: "Para defeitos voc√™ pode reclamar sim, mas o prazo √© de apenas 7 dias ap√≥s a compra.",
                            correta: false,
                            feedback: "Incorreto! O prazo para reclamar de defeitos em produtos dur√°veis √© de 90 DIAS, n√£o 7 dias."
                        },
                        {
                            texto: "Se o produto n√£o apresenta defeito agora, depois n√£o temos como fazer nada, infelizmente.",
                            correta: false,
                            feedback: "Incorreto! V√≠cios ocultos (defeitos que aparecem depois) podem ser reclamados em at√© 90 dias para produtos dur√°veis."
                        }
                    ]
                },
                {
                    id: 4,
                    nome: "Fechamento",
                    clienteFala: "Que √≥timo! Ent√£o eu posso trocar pelo outro modelo? O produto ainda est√° lacrado e tenho a nota fiscal.",
                    opcoes: [
                        {
                            texto: "N√£o posso fazer a troca porque, como expliquei, n√£o √© uma obriga√ß√£o legal da loja.",
                            correta: false,
                            feedback: "Resposta inadequada. O cliente atende aos requisitos da pol√≠tica comercial (produto lacrado + nota fiscal)."
                        },
                        {
                            texto: "Com produto lacrado e nota fiscal, posso fazer a troca sim! Qual modelo voc√™ prefere?",
                            correta: true,
                            feedback: "Parab√©ns! Voc√™ finalizou o atendimento de forma positiva, confirmando que o cliente atende aos requisitos e prosseguindo com a troca."
                        },
                        {
                            texto: "Preciso chamar meu gerente para autorizar esse tipo de procedimento de troca aqui.",
                            correta: false,
                            feedback: "Desnecess√°rio neste caso. Como o cliente atende aos requisitos da pol√≠tica (lacrado + nota), voc√™ pode resolver sem precisar escalar."
                        }
                    ]
                }
            ]
        };

        // Estado do jogo
        let currentStep = 0;
        let acertos = 0;
        let totalSteps = cenario.etapas.length;

        // ===== AUDIO SETUP =====
        // M√∫sica de fundo (volume baixo)
        const bgMusic = new Audio('assets/mixkit-disco-aint-old-school-935.mp3');
        bgMusic.loop = true;
        bgMusic.volume = 0.15; // Volume baixo

        // Web Audio API para efeito de murm√∫rio
        let audioContext = null;
        let murmurOscillator = null;
        let murmurGain = null;

        function startMurmur() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (murmurOscillator) return; // J√° est√° tocando

            murmurOscillator = audioContext.createOscillator();
            murmurGain = audioContext.createGain();

            // Configurar oscilador para som de murm√∫rio suave
            murmurOscillator.type = 'sine';
            murmurOscillator.frequency.setValueAtTime(180, audioContext.currentTime);

            // Volume muito baixo
            murmurGain.gain.setValueAtTime(0.03, audioContext.currentTime);

            // Conectar
            murmurOscillator.connect(murmurGain);
            murmurGain.connect(audioContext.destination);

            // Modula√ß√£o para parecer fala
            const lfo = audioContext.createOscillator();
            const lfoGain = audioContext.createGain();
            lfo.frequency.setValueAtTime(8, audioContext.currentTime);
            lfoGain.gain.setValueAtTime(20, audioContext.currentTime);
            lfo.connect(lfoGain);
            lfoGain.connect(murmurOscillator.frequency);
            lfo.start();

            murmurOscillator.start();
        }

        function stopMurmur() {
            if (murmurOscillator) {
                murmurOscillator.stop();
                murmurOscillator = null;
            }
        }

        // Iniciar m√∫sica automaticamente ao carregar
        bgMusic.play().catch(() => { });

        // Fun√ß√£o de cleanup para parar m√∫sica (chamada pelo app.js ao trocar p√°gina)
        function cleanupRoleplay() {
            bgMusic.pause();
            bgMusic.currentTime = 0;
            stopMurmur();
            if (audioContext) {
                audioContext.close().catch(() => { });
                audioContext = null;
            }
        }

        // Registrar cleanup globalmente para que app.js possa chamar
        window.roleplayCleanup = cleanupRoleplay;

        // Parar m√∫sica ao sair da p√°gina (fallback)
        window.addEventListener('beforeunload', cleanupRoleplay);

        // Elementos DOM
        const clienteFala = document.getElementById('cliente-fala');
        const speechBubble = document.getElementById('speech-bubble');
        const optionsContainer = document.getElementById('roleplay-options');
        const feedbackContainer = document.getElementById('roleplay-feedback');
        const feedbackContent = document.getElementById('feedback-content');
        const btnContinuar = document.getElementById('btn-continuar');
        const resultadoContainer = document.getElementById('roleplay-resultado');
        const stepCurrent = document.getElementById('step-current');
        const stepTotal = document.getElementById('step-total');

        if (!clienteFala || !optionsContainer) {
            console.error('Roleplay elements not found');
            setTimeout(initRoleplay, 100);
            return;
        }

        // Efeito m√°quina de escrever para cliente
        function typeWriter(element, text, speed, callback) {
            let i = 0;
            element.textContent = '';
            const clienteImg = document.getElementById('cliente-img');

            // Adicionar classe de tremor ao cliente e iniciar murm√∫rio
            if (clienteImg) {
                clienteImg.classList.add('speaking');
            }
            startMurmur();

            function type() {
                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                } else {
                    // Remover tremor e parar murm√∫rio quando terminar
                    if (clienteImg) {
                        clienteImg.classList.remove('speaking');
                    }
                    stopMurmur();
                    if (callback) callback();
                }
            }
            type();
        }

        // Efeito m√°quina de escrever para atendente (treme o atendente)
        function typeWriterAtendente(element, text, speed, callback) {
            let i = 0;
            element.textContent = '';
            const atendenteImg = document.getElementById('atendente-img');

            // Adicionar classe de tremor ao atendente e iniciar murm√∫rio
            if (atendenteImg) {
                atendenteImg.classList.add('speaking');
            }
            startMurmur();

            function type() {
                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                } else {
                    // Remover tremor e parar murm√∫rio quando terminar
                    if (atendenteImg) {
                        atendenteImg.classList.remove('speaking');
                    }
                    stopMurmur();
                    if (callback) callback();
                }
            }
            type();
        }

        // Carregar etapa
        function loadStep(stepIndex) {
            const etapa = cenario.etapas[stepIndex];
            currentStep = stepIndex;

            // Atualizar indicador
            stepCurrent.textContent = stepIndex + 1;
            stepTotal.textContent = totalSteps;

            // Esconder atendente da etapa anterior
            const atendenteContainer = document.getElementById('atendente-container');
            const atendenteBubble = document.getElementById('atendente-bubble');
            if (atendenteContainer) atendenteContainer.style.display = 'none';
            if (atendenteBubble) atendenteBubble.style.display = 'none';

            // Esconder op√ß√µes enquanto texto aparece
            optionsContainer.style.display = 'none';
            optionsContainer.innerHTML = '';

            // Efeito typewriter na fala do cliente
            typeWriter(clienteFala, etapa.clienteFala, 30, function () {
                // Mostrar op√ß√µes depois que o texto terminar
                etapa.opcoes.forEach((opcao, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'roleplay-option';
                    btn.innerHTML = `<span class="option-letter">${String.fromCharCode(65 + index)}</span> ${opcao.texto}`;
                    btn.addEventListener('click', function () {
                        handleOptionClick(opcao, btn);
                    });
                    optionsContainer.appendChild(btn);
                });
                optionsContainer.style.display = 'flex';
            });

            // Esconder feedback
            feedbackContainer.style.display = 'none';
        }

        // Clique em op√ß√£o
        function handleOptionClick(opcao, btn) {
            // Refer√™ncia para todas as op√ß√µes (usada depois)
            const allOptions = optionsContainer.querySelectorAll('.roleplay-option');

            // Marcar selecionada
            btn.classList.add('selected');

            // Elementos do atendente
            const atendenteContainer = document.getElementById('atendente-container');
            const atendenteBubble = document.getElementById('atendente-bubble');
            const atendenteFala = document.getElementById('atendente-fala');
            const atendenteImg = document.getElementById('atendente-img');

            if (opcao.correta) {
                btn.classList.add('correct');
                acertos++;
                if (typeof AudioManager !== 'undefined') AudioManager.playSuccess();

                // Desabilitar todas as op√ß√µes ao acertar
                allOptions.forEach(opt => {
                    opt.disabled = true;
                    opt.classList.add('disabled');
                });

                // Esconder op√ß√µes de resposta
                optionsContainer.style.display = 'none';

                // Mostrar atendente com resposta
                if (atendenteContainer && atendenteBubble) {
                    atendenteContainer.style.display = 'block';
                    atendenteBubble.style.display = 'block';

                    // Typewriter para resposta do atendente (treme o atendente)
                    typeWriterAtendente(atendenteFala, opcao.texto, 25, function () {
                        // Ap√≥s terminar, mostrar feedback
                        feedbackContent.innerHTML = `
                            <div class="feedback-icon">‚úÖ</div>
                            <p>${opcao.feedback}</p>
                        `;
                        feedbackContainer.style.display = 'block';
                        feedbackContainer.className = 'roleplay-feedback success';
                    });
                }
            } else {
                btn.classList.add('incorrect');
                if (typeof AudioManager !== 'undefined') AudioManager.playError();

                // Esconder atendente em resposta errada
                if (atendenteContainer) atendenteContainer.style.display = 'none';
                if (atendenteBubble) atendenteBubble.style.display = 'none';

                // Mostrar feedback (permanece vis√≠vel at√© acertar)
                feedbackContent.innerHTML = `
                    <div class="feedback-icon">‚ùå</div>
                    <p>${opcao.feedback}</p>
                `;
                feedbackContainer.style.display = 'block';
                feedbackContainer.className = 'roleplay-feedback error';

                // Desabilitar op√ß√£o errada imediatamente (sem esconder feedback)
                btn.disabled = true;
                btn.classList.add('disabled');
            }
        }

        // Continuar para pr√≥xima etapa
        btnContinuar.addEventListener('click', function () {
            if (currentStep < totalSteps - 1) {
                loadStep(currentStep + 1);
            } else {
                showResultado();
            }
        });

        // Mostrar resultado
        function showResultado() {
            optionsContainer.style.display = 'none';
            feedbackContainer.style.display = 'none';
            speechBubble.style.display = 'none';
            resultadoContainer.style.display = 'flex';

            const porcentagem = Math.round((acertos / totalSteps) * 100);
            let mensagem = '';
            let estrelas = '';

            if (porcentagem === 100) {
                mensagem = 'Perfeito! Voc√™ demonstrou excelente conhecimento!';
                estrelas = '‚≠ê‚≠ê‚≠ê';
            } else if (porcentagem >= 75) {
                mensagem = 'Muito bem! Voc√™ est√° no caminho certo!';
                estrelas = '‚≠ê‚≠ê';
            } else if (porcentagem >= 50) {
                mensagem = 'Bom, mas voc√™ pode melhorar. Revise o conte√∫do!';
                estrelas = '‚≠ê';
            } else {
                mensagem = 'Precisa estudar mais. Revise os m√≥dulos do curso!';
                estrelas = '';
            }

            document.getElementById('resultado-score').innerHTML = `
                <div class="score-estrelas">${estrelas}</div>
                <div class="score-texto">Voc√™ acertou ${acertos} de ${totalSteps} respostas</div>
                <div class="score-mensagem">${mensagem}</div>
            `;
        }

        // Reiniciar
        document.getElementById('btn-reiniciar-roleplay').addEventListener('click', function () {
            acertos = 0;
            resultadoContainer.style.display = 'none';
            speechBubble.style.display = 'block';
            loadStep(0);
        });

        // Iniciar
        loadStep(0);
    }

    // Inicializar ap√≥s delay
    setTimeout(initRoleplay, 50);
</script>